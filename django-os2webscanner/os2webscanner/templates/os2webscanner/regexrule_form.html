{% extends 'os2webscanner/base.html' %}
{% block topnav %}{% endblock %}
{% block rendertype %}iframe-modal{% endblock %}

{% block jquery_script %}
<script type="text/javascript">
  (function($) {
    // adding a new expression
    $("#button-add-expression").click(function() {
      var inputContainer = $("#{{ form.pattern_3.auto_id }}_container").find(".form-group:not(.displaynone)").last(); // Take the last item instead of just number _1, as we may have added more items
      var inputNameParts = inputContainer.find("input[type=\"text\"]").first().attr("name").split(/(.+_)/); // define .+_ as capturing group so we can get at the delimiter inside nameParts[1]
      var baseName = inputNameParts[1];
      var numInput = parseInt(inputNameParts[2]) + 1;
      var numLabel = $("#{{ form.pattern_3.auto_id }}_container .form-group:not(.displaynone)").index(inputContainer);
      var newInputName = baseName + (numInput);
      var containerClone = inputContainer.clone();
      var inputClone = containerClone.find("input[type=\"text\"]").first().prop("required", false);
      var labelClone = containerClone.find("label").first();

      labelClone.attr("for", "id_" + newInputName);
      labelClone.text("{{ form.pattern_3.label }}" + " " + (numLabel + 2)); // plus two because index is zero-based, *and* we want to increment by one
      inputClone.attr("name", newInputName).attr("id", "id_" + newInputName).val("").attr("value", "");
      if(!containerClone.find(".button-remove-expression").length) { // if we haven't already cloned a button for removal...
        inputClone.after($("<span/>", { // ... add the button to remove expression
          class: "input-group-btn",
          html: $("<button/>", {
            class: "btn btn-default button-remove-expression",
            type: "button",
            text: "Fjern udtryk"
          })
        }));
        inputClone.next(".input-group-btn").addBack().wrapAll("<div class=\"input-group\"></div>"); // wrap it in the input-group wrapper for proper Bootstrap styling
      }
      inputContainer.after(containerClone);
      recalcIframeHeight();
    });

    // removing an expression. We need to bind dynamically as fields do not necessarily exist on page load
    $("body").on("click", ".button-remove-expression", function() {
      var btn = $(this);
      var inputValue = btn.closest(".input-group-btn").prev("input").val();
      if(inputValue) {
        var confirmation = confirm("Feltet indeholder en værdi. Tryk OK hvis du stadig vil slette feltet.");
        if(confirmation) {
          btn.closest(".form-group").remove();
        }
      } else {
        btn.closest(".form-group").remove();
      }
      cleanupPatternNumbers();
    });

    $("form").submit(function() {
      // delete any empty expression fields, BUT not the first one
      $("#{{ form.pattern_3.auto_id }}_container").find("input[type=\"text\"]").filter(function(idx) {
        return !this.value && idx > 0;
      }).closest(".form-group").remove();

      // clean up the pattern numbers on form submit, just to be safe (even though we already did it when adding a new expression field).
      cleanupPatternNumbers();

      // If pattern_3 is set, and pattern_0 has not been set, copy value from 3 to 0, because 0 is mandatory. Also handle the disabled attr
      var pat0 = $("[name=\"pattern_0\"]");
      var pat3 = $("[name=\"pattern_3\"]");
      if(pat3.val() && pat0.prop("disabled")) {
        pat3.attr("name", "pattern_0");
        pat0.removeAttr("name");
      }
    });

    // function to clean up pattern numbers, as we need to have them numbered sequentially without gaps
    function cleanupPatternNumbers() {
      $("#{{ form.pattern_3.auto_id }}_container").find("input[type=\"text\"]").closest(".form-group").each(function(idx) { // filter specifically for input[type="text"], as we don't want to re-number the reserved fields used for CPR settings
        var $this = $(this);
        var input = $this.find("input[type=\"text\"]");
        var label = $this.find("label");
        var oldInputName = input.attr("name").split(/(.+_)/);
        input.attr("name", oldInputName[1] + (idx + 3)).attr("id", "id_" + oldInputName[1] + (idx + 3)); // plus 3 because items 0-2 are reserved for CPR settings
        label.attr("for", "id_" + oldInputName[1] + (idx + 3)).text("{{ form.pattern_3.label }} " + (idx + 1)); // we want 1-indexed labels
      });
      recalcIframeHeight();
    }

    // Handle the CPR Options when Do CPR scan is (un)checked
    $("#id_do_cpr_scan").change(function() {
      handleSubChoices($(this));
    });
    {% if not view.cpr_settings.do_cpr_scan %}
    handleSubChoices($("#id_do_cpr_scan"));
    {% endif %}

    // toggle hidden input field when selecting/deselecting a CPR setting
    $("#cpr_settings_container input[type=\"checkbox\"]").change(function() {
      $("input[value=\"_M463N74_" + $(this).val() + "\"]").prop("disabled", !$(this).prop("checked"));
    });

    // If we selected to do a CPR scan, it shouldn't be mandatory to input a regex pattern.
    $("#id_do_cpr_scan").change(function() {
      $("#id_{{ form.pattern_3.name }}").prop("required", !$(this).prop("checked")); // if CPR is checked (true), pattern_3 required attr should be false (and vice versa)
    })
  })(jQuery);
</script>
{% endblock %}
{% block body %}

{% if form.non_field_errors %}
  <ul>
    {% for error in form.non_field_errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
{% endif %}
{% if form.errors %}
<div class="alert alert-danger" role="alert">
  <p>Følgende felter er ikke udfyldt korrekt:</p>
  <ul>
    {% for error in form.errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<form class="form-horizontal" role="form" method="post">
{% csrf_token %}

  <div id="{{ form.name.auto_id }}_container" class="col-sm-12{% if form.name.errors %} has-error{% endif %}">
    <div class="form-group">
      <label class="control-label col-sm-2" for="id_{{ form.name.name }}">{{ form.name.label }}</label>
      <div class="col-sm-10">
      	<input type="text" class="form-control" name="{{ form.name.name }}" id="id_{{ form.name.name }}" {% if form.name.value %}value="{{ form.name.value }}"{% endif %} {% if form.name.field.required %}required{% endif %}>
      	{% if form.name.help_text %}
      	  <p>
            <small>{{ form.name.help_text }}</small>
          </p>
        {% endif %}
        {% if form.name.errors %}{{ form.name.errors }}{% endif %}
      </div>
    </div>
  </div>

  {% if form.organization %}
  <div id="{{ form.organization.auto_id }}_container" class="col-sm-12{% if form.organization.errors %} has-error{% endif %}">
    <div class="form-group">
      <label class="control-label col-sm-2" for="id_{{ form.organization.name }}">{{ form.organization.label }}</label>
      <div class="col-sm-10">
        <select name="{{ form.organization.name }}" id="id_{{ form.organization.name }}" class="form-control" {% if form.organization.field.required %}required{% endif %}>
          {% for value, tag in form.organization.field.choices %}
            <option value="{{ value }}"{% if form.organization.value|add:"0" == value|add:"0" %} selected{% endif %}>{{ tag }}</option>{# silly type conversion #}
          {% endfor %}
        </select>
        {% if form.organization.help_text %}
          <p>
            <small>{{ form.organization.help_text }}</small>
          </p>
        {% endif %}
        {% if form.organization.errors %}{{ form.organization.errors }}{% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if form.group %}
  <div id="{{ form.group.auto_id }}_container" class="col-sm-12{% if form.group.errors %} has-error{% endif %}">
    <div class="form-group">
      <label class="control-label col-sm-2" for="id_{{ form.group.name }}">{{ form.group.label }}</label>
      <div class="col-sm-10">
        <select name="{{ form.group.name }}" id="id_{{ form.group.name }}" class="form-control" {% if form.group.field.required %}required{% endif %}>
          {% for value, tag in form.group.field.choices %}
            <option value="{{ value }}"{% if form.group.value|add:"0" == value|add:"0" %} selected{% endif %}>{{ tag }}</option>{# silly type conversion #}
          {% endfor %}
        </select>
        {% if form.group.help_text %}
          <p>
            <small>{{ form.group.help_text }}</small>
          </p>
        {% endif %}
        {% if form.group.errors %}{{ form.group.errors }}{% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div id="{{ form.pattern_3.auto_id }}_container" class="col-sm-12{% if form.pattern_3.errors %} has-error{% endif %}">
    <p>TODO: A problem. If we saved a rule with only the CPR setting checked, that rule won't have a pattern_3 field to output, because its pattern_3 value will be the unique _M463N74_ key, which we don't want to output as a text field.</p>
    <p>So we need some way to check if this is only a CPR scan, and if so, render an extra text input just in case we want to also add our own pattern at a later time.</p>

    <div class="form-group displaynone">
      <input type="hidden" value="_M463N74_DOCPR" name="pattern_0" {% if not view.get_cpr_settings.do_cpr_scan %} disabled="disabled" {% endif %}>
    </div>
    <div class="form-group displaynone">
      <input type="hidden" value="_M463N74_DOCPRMOD11" name="pattern_1" {% if not view.get_cpr_settings.check_mod11 %} disabled="disabled" {% endif %}>
    </div>
    <div class="form-group displaynone">
      <input type="hidden" value="_M463N74_DOCPRDOB" name="pattern_2" {% if not view.get_cpr_settings.ignore_irrelevant %} disabled="disabled" {% endif %}>
    </div>

    {% for pattern_name, pattern_value in view.get_pattern_fields %}
    {% if not '_M463N74_' in pattern_value %}
    <div class="form-group">
      <label class="control-label col-sm-2" for="id_{{ pattern_name }}">{{ form.pattern_3.label }} {{ forloop.counter }}</label>
      <div class="col-sm-10">
        {% if forloop.counter > 1 %}
        <div class="input-group">
        {% endif %}
	      <input type="text" class="form-control" name="{{ pattern_name }}" id="id_{{ pattern_name }}" {% if pattern_value %}value="{{ pattern_value }}"{% endif %} {% if forloop.counter == 4 %}required{% endif %}> {# forloop.counter is 1-indexed #}
        {% if forloop.counter > 1 %}
        <span class="input-group-btn">
          <button class="btn btn-default button-remove-expression" type="button">Fjern udtryk</button>
        </span>
        {% endif %}
	      {% if form.pattern_3.help_text %}
	        <p>
            <small>{{ form.pattern_3.help_text }}</small>
          </p>
        {% endif %}
        {% if form.pattern_3.errors %}{{ form.pattern_3.errors }}{% endif %}
        {% if forloop.counter > 1 %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% endfor %}

    <div class="row">
      <div class="col-sm-offset-2 col-sm-10">
        <button id="button-add-expression" type="button" class="btn btn-default">Tilføj udtryk</button>
      </div>
    </div>
  </div>

  <div id="cpr_settings_container" class="col-sm-12">
    <div class="form-group">
      <strong class="control-label col-sm-2" for="id_cpr_rule">CPR-indstillinger</strong>
      <div class="col-sm-10">
        <div class="checkbox-group">
          <input type="checkbox" id="id_do_cpr_scan" value="DOCPR" {% if view.get_cpr_settings.do_cpr_scan %} checked="checked" {% endif %}>
          <label for="id_do_cpr_scan">
            Scan CPR
          </label>
          <input type="checkbox" id="id_check_mod11" value="DOCPRMOD11" {% if view.get_cpr_settings.check_mod11 %} checked="checked" {% endif %}>
          <label class="cpr_option" for="id_check_mod11">
            Tjek modulus-11
          </label>
          <input type="checkbox" id="id_ignore_irrelevant" value="DOCPRDOB" {% if view.get_cpr_settings.ignore_irrelevant %} checked="checked" {% endif %}>
          <label class="cpr_option" for="id_ignore_irrelevant">
            Ignorer ugyldige fødselsdatoer
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="{{ form.description.auto_id }}_container" class="col-sm-12{% if form.description.errors %} has-error{% endif %}">
    <div class="form-group">
      <label class="control-label col-sm-2" for="id_{{ form.description.name }}">{{ form.description.label }}</label>
      <div class="col-sm-10">
	<textarea class="form-control" name="{{ form.description.name }}" id="id_{{ form.description.name }}" rows="3" {% if form.description.field.required %}required{% endif %}>{% if form.description.value %}{{ form.description.value }}{% endif %}</textarea>
	{% if form.description.help_text %}
	  <p>
            <small>{{ form.description.help_text }}</small>
          </p>
        {% endif %}
        {% if form.description.errors %}{{ form.description.errors }}{% endif %}
      </div>
    </div>
  </div>

  <div id="{{ form.sensitivity.auto_id }}_container" class="col-sm-12{% if form.sensitivity.errors %} has-error{% endif %}">
    <div class="form-group">
      <label class="control-label col-sm-2" for="id_{{ form.sensitivity.name }}">{{ form.sensitivity.label }}</label>
      <div class="col-sm-10">
	<select name="{{ form.sensitivity.name }}" id="id_{{ form.sensitivity.name }}" class="form-control" {% if form.sensitivity.field.required %}required{% endif %}>
          {% for value, tag in form.sensitivity.field.choices %}
            <option value="{{ value }}"{% if form.sensitivity.value|add:"0" == value|add:"0" %} selected="selected"{% endif %}>{{ tag }}</option>
          {% endfor %}
        </select>
        {% if form.sensitivity.help_text %}
          <p>
            <small>{{ form.sensitivity.help_text }}</small>
          </p>
        {% endif %}
        {% if form.sensitivity.errors %}{{ form.sensitivity.errors }}{% endif %}
      </div>
    </div>
  </div>

  <div class="col-sm-offset-2">
    <div class="col-sm-12">
      <button type="submit" class="btn btn-primary" name="save">
        Gem ændringer
      </button>
    </div>
  </div>

    {#{ form.as_p }#}
</form>
{% endblock %}
