{% load handle_extras %}
{% load i18n %}
{% load l10n %}
{% load static %}

{% comment %} {% setvar matches_by_source_and_handled_status.mailscan.count|subtract:matches_by_source_since_last_month.mailscan.count as total_email_matches %}
{% setvar matches_by_source_and_handled_status.filescan.count|subtract:matches_by_source_since_last_month.filescan.count as total_file_matches %}
{% setvar matches_by_source_and_handled_status.webscan.count|subtract:matches_by_source_since_last_month.webscan.count as total_web_matches %}
{% setvar matches_by_source_and_handled_status.other.count|subtract:matches_by_source_since_last_month.other.count as total_other_matches %} {% endcomment %}

<div class="content" hx-push-url="true">
  <div class="content-header">
    <h1 class="page-title">{% trans "DPO statistics" %}</h1>

    <svg class="page-indicator"
         id="report-page-indicator"
         viewbox="0 0 100 100">
      <circle id="circle" cx="50" cy="50" r="45"></circle>
    </svg>

    <!-- Scannerjob chart data selection -->
    <form name="stat_form"
          class="stat_form"
          hx-get="{% url "statistics-dpo" %}"
          hx-target=".content"
          hx-select=".content"
          hx-swap="outerHTML"
          hx-trigger="change"
          hx-indicator="#report-page-indicator">
      <div class="dropdown stats_dropdown">
        <label for="scannerjobs">{% trans "scanner job"|capfirst %}</label>
        <select name="scannerjob"
                id="scannerjobs"
                data-compareto="all"
                autocomplete="off">
          <option value="all"
                  {% if scannerjobs|last == "all" %}selected="selected"{% endif %}>
            {% trans "All scannerjobs" %}
          </option>
          {% for scan in scannerjobs|first %}
            <option value="{{ scan.scanner_job_pk|unlocalize }}"
                    {% if scannerjobs|last == scan.scanner_job_pk|stringformat:"i" %}selected="selected"{% endif %}>
              {{ scan.scanner_job_name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="dropdown stats_dropdown">
        <label for="orgunits">{% trans "organizational unit"|capfirst %}</label>
        <select name="orgunit" id="orgunits" data-compareto="all" autocomplete="off">
          <option value="all"
                  {% if orgunits|last == "all" %}selected="selected"{% endif %}>{% trans "All" %}</option>
          {% for unit in orgunits|first %}
            <option value="{{ unit.uuid }}"
                    {% if orgunits|last == unit.uuid|stringformat:"s" %}selected="selected"{% endif %}>
              {{ unit.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="button"
                class="match_filtering_clear_button clear_button_dpo"
                name="clear_scannerjob"
                hx-trigger="click"
                hx-get="{{ request.path }}"
                hx-swap="outerHTML"
                hx-target=".content"
                hx-select=".content"
                hx-include="[id='filter_form'], [id='dropdown_options']"
                hx-params="not scannerjob"
                hx-indicator="#report-page-indicator">{% trans "Clear" %}</button>
      </div>
    </form>
  </div>
 
  <div class="statistics_wrapper">
    <div class="statistic_total_container">
      <!-- Total matches - mail drive -->
      <div class="statistic_total_element">
        <div>
          <div class="statistic data_box small data_box small">
            <div class="statistic_header_total">
              <div>
                <h1 class="page-title__sub">
                  {% trans "Mail drive" %}<i class="material-icons"
   aria-hidden="true"
   title="Number of matches from mail drive. Updated daily">help</i>
                </h1>
                <p class="chart_description">{% trans "Number of matches in mail drive today" %}</p>
              </div>
            </div>
            <div class="statistic_total_count">{{ matches_by_source_and_handled_status.mailscan.count }}</div>
            <div>
              <p {% if total_mailscan_count < 0 %} style="color: green;">
              {% elif total_mailscan_count > 0 %}
                style="color: red;">+
              {% else %}
                >
              {% endif %}
              {% localize %}{{ total_mailscan_count }}{% endlocalize %}
              {% trans "the last 30 days" %}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Total matches - file drive -->
    <div class="statistic_total_element">
      <div class="statistic data_box small">
        <div class="statistic_header_total">
          <div>
            <h1 class="page-title__sub">
              {% trans "File drive" %}<i class="material-icons"
   aria-hidden="true"
   title="Number of matches from file drive. Updated daily">help</i>
            </h1>
            <p class="chart_description">{% trans "Number of matches in file drive today" %}</p>
          </div>
        </div>
        <div class="statistic_total_count">{{ matches_by_source_and_handled_status.filescan.count }}</div>
        <div>
          <p {% if total_filescan_count < 0 %} style="color: green;">
          {% elif total_filescan_count > 0 %}
            style="color: red;">+
          {% else %}
            >
          {% endif %}
          {% localize %}{{ total_filescan_count }}{% endlocalize %}
          {% trans "the last 30 days" %}
        </p>
      </div>
    </div>
  </div>

  <!-- Total matches - site drive -->
  <div class="statistic_total_element">
    <div class="statistic data_box small">
      <div class="statistic_header_total">
        <div>
          <h1 class="page-title__sub">
            {% trans "Web drive" %}<i class="material-icons"
   aria-hidden="true"
   title="Number of matches from site drive. Updated daily">help</i>
          </h1>
          <p class="chart_description">{% trans "Number of matches in web drive today" %}</p>
        </div>
      </div>
      <div class="statistic_total_count">{{ matches_by_source_and_handled_status.webscan.count }}</div>
      <div>
        <p {% if total_webscan_count < 0 %} style="color: green;">
        {% elif total_webscan_count > 0 %}
          style="color: red;">+
        {% else %}
          >
        {% endif %}
        {% localize %}{{ total_webscan_count }}{% endlocalize %}
        {% trans "the last 30 days" %}
      </p>
    </div>
  </div>
</div>
 

<!-- Total matches - other sources -->
<div class="statistic_total_element">
  <div class="statistic data_box small">
    <div class="statistic_header_total">
      <div>
        <h1 class="page-title__sub">
          {% trans "Other" %}<i class="material-icons"
   aria-hidden="true"
   title="Number of matches from other sources. Updated daily">help</i>
        </h1>
        <p class="chart_description">{% trans "Number of matches in other sources today" %}</p>
      </div>
    </div>
    <div class="statistic_total_count">{{ matches_by_source_and_handled_status.other.count }}</div>
    <div>
      <p {% if total_other_count < 0 %} style="color: green;">
      {% elif total_other_count > 0 %}
        style="color: red;">+
      {% else %}
        >
      {% endif %}
      {% localize %}{{ total_other_count }}{% endlocalize %}
      {% trans "the last 30 days" %}
    </p>
  </div>
</div>
</div>
</div>
</div>
 
<div class="statistic_wrapper">
  <!-- Doughnut chart -->
  <div class="statistic data_box medium">
    <div class="statistic_header">
      <div>
        <h1 class="page-title__sub">{% trans "Handled results" %}</h1>
        <p class="chart_description" data-chartid="handling-all-results">
          {% trans "The department's percentage of handled results" %}
        </p>
      </div>
    </div>
    <div class="chart_container" data-chartid="handling-all-results">
      <div class="doughnut_chart_container">
        <div class="canvas_size donut_chart">
          <canvas id="doughnut_chart_total"></canvas>
        </div>
        <div class="doughnut_info_box">
          <h4>{% trans "Handled results" %}</h4>
          <p>{{ match_data.handled }} {% trans "of" %} {{ match_data.handled|add:match_data.unhandled }}</p>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Pie chart -->
  <div class="statistic data_box medium">
    <div class="statistic_header">
      <div>
        <h1 class="page-title__sub">{% trans "Distribution of results" %}</h1>
        <p class="chart_description" data-chartid="distribution-data-sources">
          {% trans "Results distributed by data sources" %}
        </p>
        <p class="hidden chart_description"
           data-chartid="distribution-resolution-status">{% trans "Results distributed by resolution statuses" %}</p>
      </div>
      <div class="statistic_header_nav">
        <div class="dropdown">
          <select>
            <option value="distribution-data-sources">{% trans "Data sources" %}</option>
            <option value="distribution-resolution-status">{% trans "Resolution statuses" %}</option>
          </select>
        </div>
      </div>
    </div>
    <div class="pie_chart_container chart_container canvas_size pie_chart"
         style="height: 22rem"
         data-chartid="distribution-data-sources">
      <div>
        <canvas id="pie_chart_datasources"></canvas>
      </div>
      <div id="pie_legend_datasources"></div>
    </div>
    <div class="hidden pie_chart_container chart_container canvas_size pie_chart"
         data-chartid="distribution-resolution-status">
      <div>
        <canvas id="pie_chart_resolution_status"></canvas>
      </div>
      <div id="pie_legend_resolution_status"></div>
    </div>
  </div>
</div>

<div class="statistic_wrapper">
  <!-- bar chart - matches per org unit -->
  <div class="statistic data_box large">
    <div class="statistic_header">
      <div>
        <h1 class="page-title__sub">{% trans "Department distribution" %}</h1>
        <p class="chart_description" data-chartid="department_distribution">{% trans "Matches distributed by department" %}</p>
      </div>
    </div>
    <div class="chart_container canvas_size bar_chart_horizontal"
         data-chartid="department_distribution">
      <canvas class="bar_chart" id="bar_chart_department_distribution"></canvas>
    </div>
  </div>

  <!-- bar chart - new and unhandled matches -->
  <div class="statistic data_box large">
    <div class="statistic_header">
      <div>
        <h1 class="page-title__sub">{% trans "Development overview" %}</h1>
        <p class="chart_description" data-chartid="development-new-results">{% trans "New results by month" %}</p>
        <p class="hidden chart_description"
           data-chartid="development-unhandled-results">{% trans "Unhandled results by month" %}</p>
      </div>
      <div class="statistic_header_nav">
        <div class="dropdown">
          <select>
            <option value="development-new-results">{% trans "New results" %}</option>
            <option value="development-unhandled-results">{% trans "Unhandled results" %}</option>
          </select>
        </div>
      </div>
    </div>
    <div class="chart_container " data-chartid="development-new-results">
      <canvas class="bar_chart canvas_size bar_chart_vertical"
              id="bar_chart_new_matches_by_month"></canvas>
    </div>
    <div class="hidden chart_container"
         data-chartid="development-unhandled-results">
      <canvas class="bar_chart canvas_size bar_chart_vertical"
              id="bar_chart_unhandled_matches"></canvas>
    </div>
  </div>
</div>
 
{{ source_types|json_script:"source_types" }}
{{ new_matches_by_month|json_script:"new_matches_by_month" }}
{{ unhandled_matches_by_month|json_script:"unhandled_matches_by_month" }}
{{ resolution_status|json_script:"resolution_status" }}
{{ match_status_by_org_unit|json_script:"match_status_by_org_unit" }}
{{ match_data|json_script:"match_data" }}
</div>
